â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                   ARCHITECTURE: Make.com â†’ Stack Native                        â•‘
â•‘                                                                                â•‘
â•‘  FLUX GÃ‰NÃ‰RAL: Utilisateur paie â†’ Rapport gÃ©nÃ©rÃ© â†’ Email reÃ§u                 â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1ï¸âƒ£  PAIEMENT UTILISATEUR (Frontend)                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ pages/payment-success.tsx                                           â”‚  â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  â”‚
â”‚  â”‚ - Affiche formulaire paiement (Stripe)                              â”‚  â”‚
â”‚  â”‚ - Utilisateur entre carte de crÃ©dit                                â”‚  â”‚
â”‚  â”‚ - Clique "Payer 39â‚¬"                                               â”‚  â”‚
â”‚  â”‚ - Stripe traite le paiement                                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                  â”‚                                           â”‚
â”‚                                  â–¼                                           â”‚
â”‚                    âœ… Paiement rÃ©ussi (charge.succeeded)                   â”‚
â”‚                                  â”‚                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ 2ï¸âƒ£  WEBHOOK STRIPE (Backend API)           â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚ POST https://mystylist.io/api/webhooks/stripe
        â”‚                                              â”‚
        â”‚ File 3: pages/api/webhooks/stripe.ts        â”‚
        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
        â”‚ âœ“ ReÃ§oit l'Ã©vÃ©nement charge.succeeded       â”‚
        â”‚ âœ“ VÃ©rifie la signature Stripe               â”‚
        â”‚ âœ“ Extrait metadata (user_id, email, name)  â”‚
        â”‚ âœ“ CrÃ©e rapport en DB (statut: processing)  â”‚
        â”‚ âœ“ DÃ©clenche l'Edge Function Supabase        â”‚
        â”‚ âœ“ Retourne 200 Ã  Stripe                     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ 3ï¸âƒ£  EDGE FUNCTION SUPABASE (Serverless)            â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚                                                       â”‚
        â”‚ File 1: supabase/functions/generate-report/index.ts â”‚
        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
        â”‚                                                       â”‚
        â”‚ â‘  RÃ©cupÃ¨re donnÃ©es utilisateur                      â”‚
        â”‚    â†“                                                  â”‚
        â”‚    SELECT * FROM user_profiles, colorimetry,         â”‚
        â”‚    morphology, photos WHERE user_id = ?              â”‚
        â”‚                                                       â”‚
        â”‚ â‘¡ Appelle OpenAI (7 modules = 7 appels)             â”‚
        â”‚    â†“                                                  â”‚
        â”‚    POST https://api.openai.com/v1/chat/completions  â”‚
        â”‚    â”œâ”€ ColorimÃ©trie (GPT-4)                          â”‚
        â”‚    â”œâ”€ Morphologie (GPT-4)                           â”‚
        â”‚    â”œâ”€ Profil stylistique (GPT-4)                    â”‚
        â”‚    â”œâ”€ Garde-robe capsule (GPT-4)                   â”‚
        â”‚    â”œâ”€ Mix & match (GPT-4)                           â”‚
        â”‚    â”œâ”€ Guide shopping (GPT-4)                        â”‚
        â”‚    â””â”€ Occasions spÃ©cifiques (GPT-4)                 â”‚
        â”‚                                                       â”‚
        â”‚ â‘¢ GÃ©nÃ¨re HTML complet du rapport                    â”‚
        â”‚    â†“                                                  â”‚
        â”‚    <html>                                            â”‚
        â”‚    <h1>Rapport stylistique</h1>                      â”‚
        â”‚    <section id="colorimetry">...</section>           â”‚
        â”‚    ...                                               â”‚
        â”‚    </html>                                           â”‚
        â”‚                                                       â”‚
        â”‚ â‘£ Convertit HTML â†’ PDF                              â”‚
        â”‚    â†“                                                  â”‚
        â”‚    POST https://api.html2pdf.app/v1/generate        â”‚
        â”‚    Retour: pdfBuffer (bytes)                        â”‚
        â”‚                                                       â”‚
        â”‚ â‘¤ Upload PDF sur Supabase Storage                   â”‚
        â”‚    â†“                                                  â”‚
        â”‚    supabase.storage                                  â”‚
        â”‚      .from('stylist-reports')                        â”‚
        â”‚      .upload(`reports/${userId}_${time}.pdf`, buffer)
        â”‚    Retour: file_path, public_url                    â”‚
        â”‚                                                       â”‚
        â”‚ â‘¥ Met Ã  jour rapport en DB (statut: completed)      â”‚
        â”‚    â†“                                                  â”‚
        â”‚    UPDATE reports                                    â”‚
        â”‚    SET status='completed', public_url=?, file_path=?â”‚
        â”‚    WHERE user_id = ?                                 â”‚
        â”‚                                                       â”‚
        â”‚ â‘¦ Envoie email avec lien tÃ©lÃ©chargement             â”‚
        â”‚    â†“                                                  â”‚
        â”‚    POST https://api.resend.com/emails                â”‚
        â”‚    {                                                  â”‚
        â”‚      to: user_email,                                 â”‚
        â”‚      subject: "âœ¨ Votre rapport stylistique",         â”‚
        â”‚      html: "<a href='${public_url}'>TÃ©lÃ©charger</a>" â”‚
        â”‚    }                                                  â”‚
        â”‚                                                       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ 4ï¸âƒ£  SUPABASE DATABASE (Storage)           â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚                                            â”‚
        â”‚ Tables:                                    â”‚
        â”‚  â”œâ”€ reports                                â”‚
        â”‚  â”‚  â”œâ”€ id (UUID)                           â”‚
        â”‚  â”‚  â”œâ”€ user_id                             â”‚
        â”‚  â”‚  â”œâ”€ status: "completed"                 â”‚
        â”‚  â”‚  â”œâ”€ public_url                          â”‚
        â”‚  â”‚  â”œâ”€ file_path                           â”‚
        â”‚  â”‚  â””â”€ generated_at                        â”‚
        â”‚  â”‚                                         â”‚
        â”‚  â”œâ”€ user_profiles                          â”‚
        â”‚  â”œâ”€ colorimetry                            â”‚
        â”‚  â”œâ”€ morphology                             â”‚
        â”‚  â””â”€ ...                                    â”‚
        â”‚                                            â”‚
        â”‚ Storage:                                   â”‚
        â”‚  â””â”€ stylist-reports/                       â”‚
        â”‚     â””â”€ reports/                            â”‚
        â”‚        â””â”€ user_123_1234567890.pdf âœ“       â”‚
        â”‚                                            â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â–¼              â–¼              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 5ï¸âƒ£  REACT    â”‚  â”‚ 6ï¸âƒ£  EMAIL    â”‚  â”‚ 7ï¸âƒ£  STORAGE â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚              â”‚  â”‚              â”‚  â”‚              â”‚
    â”‚ useReport    â”‚  â”‚ User reÃ§oit  â”‚  â”‚ PDF dispo    â”‚
    â”‚ Generation() â”‚  â”‚ email avec   â”‚  â”‚ 30 jours     â”‚
    â”‚              â”‚  â”‚ lien         â”‚  â”‚              â”‚
    â”‚ - Polling    â”‚  â”‚              â”‚  â”‚ URL publique:â”‚
    â”‚   toutes 5s  â”‚  â”‚ âœ‰ï¸ Ã€ recevoirâ”‚  â”‚              â”‚
    â”‚ - Affiche    â”‚  â”‚              â”‚  â”‚ https://xxx  â”‚
    â”‚   progressionâ”‚  â”‚ From: Resend â”‚  â”‚ .supabase.co â”‚
    â”‚   (30% 60%   â”‚  â”‚              â”‚  â”‚ /storage/... â”‚
    â”‚    90%)      â”‚  â”‚ Subject:     â”‚  â”‚              â”‚
    â”‚ - Quand 100%:â”‚  â”‚ "âœ¨ Rapport" â”‚  â”‚ ValiditÃ©:    â”‚
    â”‚   Affiche    â”‚  â”‚              â”‚  â”‚ 30 jours     â”‚
    â”‚   bouton     â”‚  â”‚ [TÃ©lÃ©charger]â”‚  â”‚              â”‚
    â”‚   tÃ©lÃ©chargerâ”‚  â”‚              â”‚  â”‚              â”‚
    â”‚              â”‚  â”‚              â”‚  â”‚              â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                         TIMELINE D'EXÃ‰CUTION                                   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

T+0s    â”œâ”€ Utilisateur clique "Payer 39â‚¬"
        â”‚
T+1s    â”œâ”€ Stripe traite le paiement
        â”‚  â””â”€ charge.succeeded âœ“
        â”‚
T+2s    â”œâ”€ Webhook â†’ pages/api/webhooks/stripe.ts
        â”‚  â””â”€ CrÃ©e rapport (status: processing)
        â”‚
T+3s    â”œâ”€ Edge Function dÃ©marre
        â”‚  â”œâ”€ RÃ©cupÃ¨re profil utilisateur
        â”‚  â””â”€ Appelle OpenAI (7 modules en sÃ©quence)
        â”‚
T+60s   â”œâ”€ OpenAI a gÃ©nÃ©rÃ© 7 sections
        â”‚  â”œâ”€ ColorimÃ©trie: 12 sec
        â”‚  â”œâ”€ Morphologie: 10 sec
        â”‚  â”œâ”€ Styling: 8 sec
        â”‚  â”œâ”€ Capsule: 15 sec
        â”‚  â”œâ”€ Mix & Match: 12 sec
        â”‚  â”œâ”€ Shopping: 8 sec
        â”‚  â””â”€ Occasions: 10 sec
        â”‚
T+90s   â”œâ”€ html2pdf convertit HTML â†’ PDF
        â”‚
T+120s  â”œâ”€ PDF uploadÃ© sur Storage
        â”‚  â”œâ”€ file_path: reports/user_123_xxx.pdf
        â”‚  â””â”€ public_url: https://xxx.supabase.co/...
        â”‚
T+125s  â”œâ”€ Rapport mis Ã  jour en DB (status: completed)
        â”‚
T+130s  â”œâ”€ Email envoyÃ© via Resend
        â”‚
T+140s  â”œâ”€ UI React affiche "Rapport gÃ©nÃ©rÃ©! âœ“"
        â”‚
T+145s  â””â”€ Utilisateur clique "TÃ©lÃ©charger"
           â””â”€ PDF tÃ©lÃ©chargÃ© localement

â±ï¸  TOTAL: ~2-3 MINUTES

(Vs Make.com: 5-10 min)


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                      COMPOSANTS & FICHIERS                                     â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€ FRONTEND (React) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                               â”‚
â”‚  ğŸ“„ pages/payment-success.tsx (FILE 4 - exemple)                            â”‚
â”‚  â”œâ”€ Affiche le formulaire paiement Stripe                                   â”‚
â”‚  â”œâ”€ Appelle useReportGeneration() hook                                      â”‚
â”‚  â””â”€ Affiche progression (30%, 60%, 90%, puis âœ“)                             â”‚
â”‚                                                                               â”‚
â”‚  ğŸª hooks/useReportGeneration.ts (FILE 2)                                   â”‚
â”‚  â”œâ”€ useCallback(startGeneration) â†’ dÃ©clenche /api/trigger-report-generation â”‚
â”‚  â”œâ”€ Polling toutes 5s: SELECT * FROM reports WHERE status=completed        â”‚
â”‚  â”œâ”€ setStatus() pour mettre Ã  jour l'UI                                     â”‚
â”‚  â””â”€ downloadReport() pour tÃ©lÃ©charger le PDF                                â”‚
â”‚                                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ BACKEND API (Next.js) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                                â”‚
â”‚  ğŸ”Œ pages/api/webhooks/stripe.ts (FILE 3)                                    â”‚
â”‚  â”œâ”€ ReÃ§oit POST de Stripe avec stripe-signature                              â”‚
â”‚  â”œâ”€ VÃ©rifie signature: stripe.webhooks.constructEvent()                      â”‚
â”‚  â”œâ”€ Extrait metadata: user_id, email, name                                   â”‚
â”‚  â”œâ”€ InsÃ¨re rapport: INSERT INTO reports (user_id, status='processing')       â”‚
â”‚  â””â”€ DÃ©clenche Edge Function: fetch(.../functions/v1/generate-report)         â”‚
â”‚     â””â”€ Passe: { user_id, user_email, user_name, report_id }                 â”‚
â”‚                                                                                â”‚
â”‚  ğŸ”€ pages/api/trigger-report-generation.ts (optionnel)                      â”‚
â”‚  â””â”€ Endpoint pour React hook (si polling cÃ´tÃ© client)                        â”‚
â”‚                                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ EDGE FUNCTION (Supabase) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                               â”‚
â”‚  âš¡ supabase/functions/generate-report/index.ts (FILE 1)                    â”‚
â”‚  â”œâ”€ ReÃ§oit POST du webhook (ou du hook React)                              â”‚
â”‚  â”œâ”€ RÃ©cupÃ¨re profil: SELECT ... FROM user_profiles JOIN colorimetry ...    â”‚
â”‚  â”œâ”€ Appelle OpenAI 7 fois (GPT-4 turbo)                                    â”‚
â”‚  â”‚  â”œâ”€ GÃ©nÃ¨re HTML colorimÃ©trie                                             â”‚
â”‚  â”‚  â”œâ”€ GÃ©nÃ¨re HTML morphologie                                              â”‚
â”‚  â”‚  â”œâ”€ GÃ©nÃ¨re HTML styling                                                  â”‚
â”‚  â”‚  â”œâ”€ GÃ©nÃ¨re HTML capsule + mix & match                                   â”‚
â”‚  â”‚  â”œâ”€ GÃ©nÃ¨re HTML shopping                                                 â”‚
â”‚  â”‚  â””â”€ GÃ©nÃ¨re HTML occasions + FAQ                                          â”‚
â”‚  â”‚                                                                            â”‚
â”‚  â”œâ”€ Compile HTML complet (7 sections)                                       â”‚
â”‚  â”œâ”€ Appelle html2pdf.app: HTML â†’ PDF (ArrayBuffer)                         â”‚
â”‚  â”œâ”€ Upload PDF: supabase.storage.upload(...)                               â”‚
â”‚  â”œâ”€ Met Ã  jour DB: UPDATE reports SET status='completed', public_url=...   â”‚
â”‚  â”œâ”€ Envoie email: fetch("https://api.resend.com/emails")                   â”‚
â”‚  â””â”€ Retourne 200 (succÃ¨s)                                                   â”‚
â”‚                                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ DONNÃ‰ES & STORAGE (Supabase) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                                â”‚
â”‚  ğŸ—„ï¸  Tables PostgreSQL:                                                      â”‚
â”‚  â”œâ”€ reports (id, user_id, status, public_url, file_path, generated_at)      â”‚
â”‚  â”œâ”€ user_profiles (id, first_name, email, photos, preferred_brands)        â”‚
â”‚  â”œâ”€ colorimetry (id, user_id, season, undertone, colors)                  â”‚
â”‚  â”œâ”€ morphology (id, user_id, type, measurements)                           â”‚
â”‚  â”œâ”€ styling (id, user_id, archetypes)                                       â”‚
â”‚  â”œâ”€ wardrobe (id, user_id, item_type, product_name, brand, url)           â”‚
â”‚  â”œâ”€ mix_match_formulas (id, user_id, title, occasion, items)              â”‚
â”‚  â””â”€ recommendations (id, user_id, brand_name, description, website)        â”‚
â”‚                                                                                â”‚
â”‚  ğŸ“¦ Storage Buckets:                                                         â”‚
â”‚  â””â”€ stylist-reports/                                                         â”‚
â”‚     â””â”€ reports/                                                              â”‚
â”‚        â”œâ”€ user_123_1234567890.pdf                                           â”‚
â”‚        â”œâ”€ user_456_1234567891.pdf                                           â”‚
â”‚        â””â”€ ...                                                                 â”‚
â”‚                                                                                â”‚
â”‚  RLS Policies: Utilisateurs voient seulement leurs donnÃ©es                  â”‚
â”‚                                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ SERVICES EXTERNES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                               â”‚
â”‚  ğŸ” Stripe                                                                   â”‚
â”‚  â””â”€ charge.succeeded â†’ Webhook â†’ /api/webhooks/stripe                       â”‚
â”‚                                                                               â”‚
â”‚  ğŸ¤– OpenAI                                                                   â”‚
â”‚  â””â”€ POST /v1/chat/completions (GPT-4 turbo)                                â”‚
â”‚     â”œâ”€ GÃ©nÃ¨re sections HTML du rapport                                      â”‚
â”‚     â””â”€ max_tokens: 4000 â†’ 3000 (pour Ã©conomiser)                            â”‚
â”‚                                                                               â”‚
â”‚  ğŸ“„ html2pdf.app                                                             â”‚
â”‚  â””â”€ POST /v1/generate (HTML â†’ PDF)                                          â”‚
â”‚     â”œâ”€ Format: A4                                                            â”‚
â”‚     â”œâ”€ Margin: 10mm                                                          â”‚
â”‚     â””â”€ Retour: ArrayBuffer (pdfBuffer)                                      â”‚
â”‚                                                                               â”‚
â”‚  ğŸ“§ Resend                                                                   â”‚
â”‚  â””â”€ POST /emails                                                             â”‚
â”‚     â”œâ”€ From: reports@mystylist.io                                            â”‚
â”‚     â”œâ”€ To: user_email                                                        â”‚
â”‚     â””â”€ HTML: <a href="${publicUrl}">TÃ©lÃ©charger</a>                         â”‚
â”‚                                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                          FLUX DONNÃ‰ES                                          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

user@browser
    â”‚
    â”œâ”€ Remplit questionnaire (colorimÃ©trie, morphologie, photos)
    â”‚  â””â”€ DonnÃ©es enregistrÃ©es: user_profiles, colorimetry, morphology, photos
    â”‚
    â”œâ”€ Clique "Payer 39â‚¬"
    â”‚  â””â”€ Stripe.createPaymentIntent({ metadata: { user_id, email, name } })
    â”‚
    â”œâ”€ ComplÃ¨te paiement (carte 4242...)
    â”‚  â””â”€ charge.succeeded âœ“
    â”‚
    â””â”€ ReÃ§oit email Resend
       â””â”€ Contient lien public pour tÃ©lÃ©charger le PDF (30 jours)

=============

Flux donnÃ©es:
                    
Supabase DB         â† user_profiles, colorimetry, morphology
    â†‘
    â”‚
    â”œâ”€ Edge Function rÃ©cupÃ¨re
    â”‚
    â”œâ”€ Appelle OpenAI 7x
    â”‚
    â”œâ”€ GÃ©nÃ¨re HTML complet du rapport
    â”‚
    â”œâ”€ Convertit HTML â†’ PDF (html2pdf.app)
    â”‚
    â”œâ”€ Upload PDF â†’ Supabase Storage
    â”‚  â””â”€ public_url = https://xxx.supabase.co/storage/v1/object/public/...
    â”‚
    â”œâ”€ Met Ã  jour DB: reports.public_url = public_url
    â”‚
    â””â”€ Envoie email Resend
       â””â”€ user_email reÃ§oit lien de tÃ©lÃ©chargement


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                         COÃ›TS ESTIMÃ‰S                                          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Par rapport gÃ©nÃ©rÃ© (39â‚¬ vendu):

Make.com            : â‚¬0.40
â”œâ”€ CoÃ»t scÃ©nario: â‚¬0.10
â””â”€ DÃ©marrage: â‚¬0.30

Stack Native        : â‚¬0.05
â”œâ”€ OpenAI (0.74â‚¬): â‚¬0.03
â”œâ”€ html2pdf (0.08â‚¬): â‚¬0.008
â”œâ”€ Supabase (inclus): â‚¬0.005
â””â”€ Resend (inclus): â‚¬0.012

Ã‰CONOMIE            : â‚¬0.35/rapport

Avec 50 rapports/mois:
Make    : â‚¬20-50/mois
Native  : â‚¬2.50/mois  â† 20x moins cher!

